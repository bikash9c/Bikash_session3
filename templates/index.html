<!DOCTYPE html>
<html>
<head>
    <title>Semantic Explorer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>üîé Semantic Explorer</h1>

    <form id="explore-form">
        <input type="text" id="theme" name="theme" placeholder="Enter a theme..." required>
        <button type="submit">Explore</button>
    </form>

    <div id="status"></div>
    <div id="plot"></div>
    <div id="trivia-box"></div>
    <div id="cluster-summaries"></div>

    <script>
    document.getElementById("explore-form").addEventListener("submit", function(e){
        e.preventDefault();
        let theme = document.getElementById("theme").value;

        // Reset status with step placeholders
        document.getElementById("status").innerHTML = `
            <p>‚è≥ Generating plot for <b>${theme}</b>...</p>
            <ul id="steps">
                <li id="step1">üîπ Using Gemini to generate related words</li>
                <li id="step2">üîπ Using Gemini to create embeddings</li>
                <li id="step3">üîπ Applying PCA for dimensionality reduction</li>
                <li id="step4">üîπ Running KMeans clustering</li>
                <li id="step5">üîπ Using Gemini again to summarize clusters</li>
            </ul>
            <p id="final-status"><i>Please wait, this may take a few seconds...</i></p>
        `;

        // Simulate progress updates every 1.5s until fetch completes
        let stepIds = ["step1","step2","step3","step4","step5"];
        let stepIndex = 0;
        let progressInterval = setInterval(() => {
            if (stepIndex < stepIds.length) {
                document.getElementById(stepIds[stepIndex]).innerHTML = 
                    "‚úÖ " + document.getElementById(stepIds[stepIndex]).innerText.slice(2);
                stepIndex++;
            } else {
                clearInterval(progressInterval);
            }
        }, 1500);

        // Fetch data
        fetch("/explore", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({theme: theme})
        })
        .then(res => res.json())
        .then(res => {
            clearInterval(progressInterval); // stop fake updates

            // Mark all as done ‚úÖ
            stepIds.forEach(id => {
                let el = document.getElementById(id);
                if (el && !el.innerText.startsWith("‚úÖ")) {
                    el.innerHTML = "‚úÖ " + el.innerText.slice(2);
                }
            });

            // Replace only the last line
            document.getElementById("final-status").outerHTML = `
                <p>‚úÖ Plot generated successfully for <b>${res.theme}</b>! 
                Hover over points to see their cluster.<br>
                ‚è±Ô∏è Time taken: ${res.elapsed_time} seconds.</p>
            `;

            // Plot with Plotly
            let trace = {
                x: res.data.map(d => d.x),
                y: res.data.map(d => d.y),
                mode: "markers+text",
                type: "scatter",
                text: res.data.map(d => d.word),
                textposition: "top center",
                marker: {
                    color: res.data.map(d => d.cluster),
                    colorscale: "Viridis",
                    showscale: true,
                    colorbar: { title: "Cluster" }
                }
            };
            Plotly.newPlot("plot", [trace], {title: "Semantic Map (Gemini + PCA + KMeans)"});

            // Cluster summaries
            let summaryHTML = "<h3>Cluster Summaries</h3><ul>";
            res.cluster_summaries.forEach(c => {
                summaryHTML += `<li><b>Cluster ${c.id}</b>: ${c.summary}</li>`;
            });
            summaryHTML += "</ul>";
            document.getElementById("cluster-summaries").innerHTML = summaryHTML;

            // Trivia on click
            document.getElementById("plot").on('plotly_click', function(evt){
                let word = evt.points[0].text;
                fetch("/trivia", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({word: word})
                })
                .then(r => r.json())
                .then(r => {
                    document.getElementById("trivia-box").innerHTML =
                        `<p><b>${word}:</b> ${r.trivia}</p>`;
                });
            });
        });
    });
    </script>
</body>
</html>
