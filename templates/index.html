<!DOCTYPE html>
<html>
<head>
    <title>Semantic Explorer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>üîé Semantic Explorer</h1>

    <form id="explore-form">
        <!-- Updated prompt -->
        <input type="text" id="theme" name="theme" placeholder="Enter a word or short phrase as theme..." required>
        <button type="submit">Explore</button>
    </form>

    <div id="status"></div>
    <div id="plot"></div>
    <div id="trivia-box"></div>
    <div id="cluster-summaries"></div>

    <script>
    document.getElementById("explore-form").addEventListener("submit", function(e){
        e.preventDefault();
        let theme = document.getElementById("theme").value;

        // Show initial Gemini steps with fake ticks (‚è≥ ‚Üí ‚úÖ)
        document.getElementById("status").innerHTML = `
            <p>‚è≥ Generating plot for <b>${theme}</b>...</p>
            <ul id="gemini-steps">
                <li>‚è≥ Using Gemini to generate related words</li>
                <li>‚è≥ Using Gemini to create embeddings</li>
                <li>‚è≥ Applying PCA for dimensionality reduction</li>
                <li>‚è≥ Running KMeans clustering</li>
                <li>‚è≥ Using Gemini again to summarize clusters</li>
            </ul>
            <p id="wait-msg"><i>Please wait, this may take a few seconds...</i></p>
        `;

        // Animate fake ticks (1 per second)
        const steps = document.querySelectorAll("#gemini-steps li");
        let i = 0;
        let tickInterval = setInterval(() => {
            if (i < steps.length) {
                steps[i].innerHTML = steps[i].innerHTML.replace("‚è≥", "‚úÖ");
                i++;
            } else {
                clearInterval(tickInterval);
            }
        }, 1000);

        // Send to backend
        fetch("/explore", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({theme: theme})
        })
        .then(res => res.json())
        .then(res => {
            // ‚úÖ Replace only the waiting message with success
            let waitMsg = document.getElementById("wait-msg");
            if (waitMsg) {
                waitMsg.outerHTML = `
                    <p>‚úÖ Plot generated successfully for <b>${res.theme}</b>! 
                    Hover over points to see their cluster.<br>
                    ‚è±Ô∏è Time taken: ${res.elapsed_time} seconds.</p>
                `;
            }

            // Plot with Plotly
            let trace = {
                x: res.data.map(d => d.x),
                y: res.data.map(d => d.y),
                mode: "markers+text",
                type: "scatter",
                text: res.data.map(d => d.word),  // word labels
                textposition: "top center",
                marker: {
                    color: res.data.map(d => d.cluster),
                    colorscale: "Viridis",
                    showscale: true,
                    colorbar: { title: "Cluster" }
                },
                // üëá Hover shows word + cluster ID
                hovertemplate: "<b>%{text}</b><br>Cluster: %{marker.color}<extra></extra>"
            };
            Plotly.newPlot("plot", [trace], {title: "Semantic Map (Gemini + PCA + KMeans)"});

            // Cluster summaries
            let summaryHTML = "<h3>Cluster Summaries</h3><ul>";
            res.cluster_summaries.forEach(c => {
                summaryHTML += `<li><b>Cluster ${c.id}</b>: ${c.summary}</li>`;
            });
            summaryHTML += "</ul>";
            document.getElementById("cluster-summaries").innerHTML = summaryHTML;

            // Trivia on click
            document.getElementById("plot").on('plotly_click', function(evt){
                let word = evt.points[0].text;
                fetch("/trivia", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({word: word})
                })
                .then(r => r.json())
                .then(r => {
                    document.getElementById("trivia-box").innerHTML =
                        `<p><b>${word}:</b> ${r.trivia}</p>`;
                });
            });
        });
    });
    </script>
</body>
</html>
