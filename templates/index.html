<!DOCTYPE html>
<html>
<head>
    <title>Semantic Explorer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>ðŸ”Ž Semantic Explorer</h1>

    <form method="POST">
        <input type="text" name="theme" placeholder="Enter a theme..." required>
        <button type="submit">Explore</button>
    </form>

    {% if theme %}
        <h2>Theme: {{ theme }}</h2>

        <!-- Status message -->
        {% if status_msg %}
            <p id="status-msg">{{ status_msg }}</p>
        {% endif %}

        <div id="plot"></div>
        <div id="trivia-box"></div>

        {% if cluster_summaries %}
            <h3>Cluster Summaries</h3>
            <ul>
                {% for cluster in cluster_summaries %}
                    <li><b>Cluster {{ cluster.id }}</b>: {{ cluster.summary }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <script>
            let data = {{ data_json|safe }};

            // One trace with colors by cluster
            let trace = {
                x: data.map(d => d.x),
                y: data.map(d => d.y),
                mode: "markers+text",
                type: "scatter",
                text: data.map(d => d.word),
                textposition: "top center",
                marker: {
                    size: 12,
                    color: data.map(d => d.cluster),   // cluster as color
                    colorscale: "Set1",
                    showscale: true
                },
                hovertemplate: "<b>%{text}</b><br>Cluster: %{marker.color}<extra></extra>"
            };

            let layout = {
                title: "Semantic Map (Gemini + PCA + KMeans)",
                xaxis: {title: "PC1"},
                yaxis: {title: "PC2"}
            };

            Plotly.newPlot("plot", [trace], layout).then(() => {
                // Update status message when plot is done
                document.getElementById("status-msg").innerText = 
                    "âœ… Plot generated successfully! Hover over points to see their cluster.";
            });

            // Trivia on click
            document.getElementById("plot").on('plotly_click', function(data){
                let word = data.points[0].text;
                fetch("/trivia", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({word: word})
                })
                .then(res => res.json())
                .then(res => {
                    document.getElementById("trivia-box").innerHTML = 
                        "<p><b>" + word + ":</b> " + res.trivia + "</p>";
                });
            });
        </script>
    {% endif %}
</body>
</html>
